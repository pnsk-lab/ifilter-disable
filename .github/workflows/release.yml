name: Release (Windows)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.2.3 or v1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Mark as prerelease?"
        required: false
        default: false
        type: boolean

permissions:
  contents: write # releases を作る/asset を上げる

concurrency:
  group: release-windows-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version + tag
        id: ver
        shell: pwsh
        run: |
          $inputVersion = "${{ inputs.version }}".Trim()
          if ([string]::IsNullOrWhiteSpace($inputVersion)) {
            Write-Error "version is required"
            exit 1
          }

          if ($inputVersion.StartsWith("v")) {
            $tag = $inputVersion
          } else {
            $tag = "v$inputVersion"
          }

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build (release)
        run: cargo build --release

      - name: Detect built exe
        id: bin
        shell: pwsh
        run: |
          $cargoToml = Get-Content -Raw -Encoding UTF8 "Cargo.toml"
          $m = [regex]::Match($cargoToml, '(?m)^\s*name\s*=\s*"(.*?)"\s*$')
          if (-not $m.Success) { throw "Cannot find package name in Cargo.toml" }

          $pkgName = $m.Groups[1].Value
          $candidates = @(
            "$pkgName.exe",
            ($pkgName -replace '-', '_') + ".exe"
          ) | Select-Object -Unique

          $found = $null
          foreach ($c in $candidates) {
            $p = Join-Path "target\release" $c
            if (Test-Path $p) { $found = $p; break }
          }
          if (-not $found) {
            Get-ChildItem "target\release" | Format-Table -AutoSize | Out-String | Write-Host
            throw "Built exe not found"
          }

          # 絶対パス + '/' に正規化（ここが重要）
          $abs = (Resolve-Path $found).Path
          $absPosix = $abs -replace '\\','/'

          "exe_abs=$absPosix" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create GitHub Release + Upload exe
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            ${{ steps.bin.outputs.exe_abs }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
